---
title: "A2 Eric"
output: html_document
date: "2022-11-21"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load libraries 

```{r}
library(tidyverse)
library(mgcv)
library(xgboost)
library(missForest)
library(doParallel)
library(cesR)
library(caret)
library(randomForest)
library(GGally)
registerDoParallel(cores=24)
```

# load in finished datasets 

```{r}
set.seed(123)
predictors_full <- read_csv("ces2019_web_cleaned_imputed.csv") %>% mutate_if(is.character, as.factor) %>% select(-c(income_number)) %>% mutate(vote_choice = as.factor(vote_choice)) %>% as.data.frame()
predictors_full_no_na <- read_csv("ces2019_web_cleaned_no_na.csv") %>% mutate_if(is.character, as.factor) %>% select(-c(income_number)) %>% mutate(vote_choice = as.integer(vote_choice)) %>% as.data.frame()

no_na_train <- predictors_full_no_na %>% sample_frac(0.8)
no_na_test <- predictors_full_no_na %>% anti_join(no_na_train, by = "cps19_ResponseId")

no_na_train <- no_na_train %>% select(-c(cps19_ResponseId))
no_na_test <- no_na_test %>% select(-c(cps19_ResponseId))

glimpse(predictors_full)
glimpse(predictors_full_no_na)
```

# data exploration 

## perform feature selection 
```{r}
# use recursive feature selection 
predictors <- no_na_train %>% select(-c(vote_choice))
output <- no_na_train %>% select(vote_choice)
rfe_control <- rfeControl(
                      functions = rfFuncs,
                      method = "repeatedcv",
                      repeats = 5,
                      number = 5)
rfe_predictors <- rfe(x = predictors[, 1:ncol(predictors)], y = output[, 1], sizes = c(1:ncol(predictors)), rfeControl = rfe_control)

```

```{r}
rfe_predictors
predictors(rfe_predictors)
```

# model tests

```{r}
library(GGally)
ggpairs(predictors_full_no_na %>% select(c(liberal_favour, conservative_favour, ndp_favour, bloc_favour, green_favour, vote_choice)))
```

## GAM

```{r}
library(parallel)
test_gam <- mgcv::gam(list(vote_choice ~ s(liberal_favour), 
                           ~ s(liberal_favour), 
                           ~ s(liberal_favour),
                           ~ s(liberal_favour),
                           ~ s(liberal_favour)),
                      data = no_na_train, 
                      family = multinom(K=5), 
                      method = "REML")

ran_effects_gam_model <- mgcv::gam(data = no_na_train, formula = 
                         list(
                           vote_choice ~ s(province, bs="re") + s(health, bs = "re") +s(age_category, bs = "re") + s(education, bs = "re") + s(income_category, bs="re") + s(marital_status, bs = "re") + s(language, bs = "re") + s(gender, bs = "re") + s(owns_house, bs = "re") + s(born_in_canada, bs = "re") + s(citizenship, bs="re"), 
                           ~ s(province, bs="re") + s(health, bs = "re") +s(age_category, bs = "re") + s(education, bs = "re") + s(income_category, bs="re") + s(marital_status, bs = "re") + s(language, bs = "re") + s(gender, bs = "re") + s(owns_house, bs = "re") + s(born_in_canada, bs = "re") + s(citizenship, bs="re"), 
                           ~ s(province, bs="re") + s(health, bs = "re") +s(age_category, bs = "re") + s(education, bs = "re") + s(income_category, bs="re") + s(marital_status, bs = "fs") + s(language, bs = "re") + s(gender, bs = "re") + s(owns_house, bs = "re") + s(born_in_canada, bs = "re") + s(citizenship, bs="re"),
                           ~ s(province, bs="re") + s(health, bs = "re") +s(age_category, bs = "re") + s(education, bs = "re") + s(income_category, bs="re") + s(marital_status, bs = "re") + s(language, bs = "re") + s(gender, bs = "re") + s(owns_house, bs = "re") + s(born_in_canada, bs = "re") + s(citizenship, bs="re"),
                           ~ s(province, bs="re") + s(health, bs = "re") +s(age_category, bs = "re") + s(education, bs = "re") + s(income_category, bs="re") + s(marital_status, bs = "re") + s(language, bs = "re") + s(gender, bs = "re") + s(owns_house, bs = "re") + s(born_in_canada, bs = "re") + s(citizenship, bs="re")
                        ), 
                       family = mgcv::multinom(K=5),  
                       method="REML")
summary(ran_effects_gam_model)


# random intercepts only 
rfe_mixed_effects_gam_model <- mgcv::gam(data = no_na_train, 
                                         formula = list(
                                           vote_choice ~ s(liberal_favour, bs="ps") + s(conservative_favour, bs="ps") + s(ndp_favour, bs="ps") + s(green_favour, bs="ps") + s(people_favour, bs="ps") + s(bloc_favour, bs="ps") + s(province, bs = "re") + s(income_category, bs = "re") + s(age_category, bs = "re") + s(language, bs = "re") + s(education, bs = "re") + s(marital_status, bs = "re"),
                                           ~ s(liberal_favour, bs="ps") + s(conservative_favour, bs="ps") + s(ndp_favour, bs="ps") + s(green_favour, bs="ps") + s(people_favour, bs="ps") + s(bloc_favour, bs="ps") + s(province, bs = "re") + s(income_category, bs = "re") + s(age_category, bs = "re") + s(language, bs = "re") + s(education, bs = "re") + s(marital_status, bs = "re"),
                                           ~ s(liberal_favour, bs="ps") + s(conservative_favour, bs="ps") + s(ndp_favour, bs="ps") + s(green_favour, bs="ps") + s(people_favour, bs="ps") + s(bloc_favour, bs="ps") + s(province, bs = "re") + s(income_category, bs = "re") + s(age_category, bs = "re") + s(language, bs = "re") + s(education, bs = "re") + s(marital_status, bs = "re"),
                                           ~ s(liberal_favour, bs="ps") + s(conservative_favour, bs="ps") + s(ndp_favour, bs="ps") + s(green_favour, bs="ps") + s(people_favour, bs="ps") + s(bloc_favour, bs="ps") + s(province, bs = "re") + s(income_category, bs = "re") + s(age_category, bs = "re") + s(language, bs = "re") + s(education, bs = "re") + s(marital_status, bs = "re"),
                                           ~ s(liberal_favour, bs="ps") + s(conservative_favour, bs="ps") + s(ndp_favour, bs="ps") + s(green_favour, bs="ps") + s(people_favour, bs="ps") + s(bloc_favour, bs="ps") + s(province, bs = "re") + s(income_category, bs = "re") + s(age_category, bs = "re") + s(language, bs = "re") + s(education, bs = "re") + s(marital_status, bs = "re")
                                         ), 
                                         family = mgcv::multinom(K=5), 
                                         method = "REML")

rfe_fixed_effects_gam_model <- mgcv::gam(data = no_na_train, 
                                         formula = list(
                                           vote_choice ~ s(liberal_favour, bs="ps") + s(conservative_favour, bs="ps") + s(ndp_favour, bs="ps") + s(green_favour, bs="ps") + s(people_favour, bs="ps") + s(bloc_favour, bs="ps") + s(province, bs = "re") + s(income_category, bs = "re") + s(age_category, bs = "re") + s(language, bs = "re") + s(education, bs = "re") + s(marital_status, bs = "re"),
                                           ~ s(liberal_favour, bs="ps") + s(conservative_favour, bs="ps") + s(ndp_favour, bs="ps") + s(green_favour, bs="ps") + s(people_favour, bs="ps") + s(bloc_favour, bs="ps"),
                                           ~ s(liberal_favour, bs="ps") + s(conservative_favour, bs="ps") + s(ndp_favour, bs="ps") + s(green_favour, bs="ps") + s(people_favour, bs="ps") + s(bloc_favour, bs="ps"),
                                           ~ s(liberal_favour, bs="ps") + s(conservative_favour, bs="ps") + s(ndp_favour, bs="ps") + s(green_favour, bs="ps") + s(people_favour, bs="ps") + s(bloc_favour, bs="ps"),
                                           ~ s(liberal_favour, bs="ps") + s(conservative_favour, bs="ps") + s(ndp_favour, bs="ps") + s(green_favour, bs="ps") + s(people_favour, bs="ps") + s(bloc_favour, bs="ps")
                                         ), 
                                         family = mgcv::multinom(K=5), 
                                         control = mgcv::gam.control(nthreads= 24))

```
